# Swag1155 Complete Reference & Integration Guide

**Complete reference and integration guide** for the Swag1155 ERC-1155 Design-based contract.

**Contract**: `contracts/Swag1155.sol`  
**Version**: 3.0 (Design-based Architecture)  
**Last Updated**: January 2026

**⚠️ BREAKING CHANGES**: This is a complete rewrite. Each contract instance represents ONE Design.

---

## Table of Contents

### Part I: Contract Reference
1. [Overview](#overview)
2. [Data Structures](#data-structures)
3. [State Variables](#state-variables)
4. [User Functions](#user-functions)
5. [Admin Functions](#admin-functions)
6. [View Functions](#view-functions)
7. [Events](#events)
8. [Error Messages](#error-messages)
9. [Discount System](#discount-system)

### Part II: Frontend Integration
10. [Initial Setup](#initial-setup)
11. [Type Definitions](#type-definitions)
12. [Hooks & Utilities](#hooks--utilities)
13. [Admin Components](#admin-components)
14. [User Components](#user-components)
15. [Redemption Flow](#redemption-flow)
16. [Testing Checklist](#testing-checklist)
17. [Troubleshooting](#troubleshooting)

---

# Part I: Contract Reference

## Overview

Swag1155 is an ERC-1155 contract for managing swag Designs. **Each contract instance represents one Design**. Key features:

- **Design-based architecture** - One Design per contract deployment
- **Sequential token IDs** - Each mint gets unique ID (1, 2, 3...)
- **Size as trait** - Size selected during mint, stored as trait
- **Configurable payment token** - Not limited to USDC
- **Optional discount system** - POAP and smart contract ownership discounts
- **Physical redemption tracking** - Per-token redemption status

### Role Hierarchy

| Role | Can Do | Granted By |
|------|--------|------------|
| `DEFAULT_ADMIN_ROLE` | Add/remove admins | Contract deployer |
| `ADMIN_ROLE` | Manage Design, configure discounts, mark fulfillment | DEFAULT_ADMIN_ROLE |

---

## Data Structures

### DesignInfo

Stores all Design metadata (single Design per contract).

```solidity
struct DesignInfo {
    string name;              // e.g., "ETH Cali Tee"
    string description;       // Product description
    string imageUrl;          // IPFS/image URL
    string website;           // Optional website URL
    address paymentToken;     // ERC20 token address
    uint256 pricePerUnit;     // Price in payment token decimals
    uint256 totalSupply;      // Maximum mints
    uint256 minted;           // Current mint count
    bool active;             // Sale status
    string gender;            // "Male", "Female", "Unisex"
    string color;             // "Black", "White", etc.
    string style;             // "Casual", "Formal", etc.
}
```

### DiscountConfig

Optional discount configuration (all fields can be disabled).

```solidity
struct DiscountConfig {
    bool smartContractEnabled;    // Enable smart contract discount
    address smartContractAddress;  // Contract to check (address(0) if disabled)
    uint256 smartContractDiscount; // Discount amount/percentage
    bool poapEnabled;              // Enable POAP discount
    uint256 poapEventId;          // POAP event ID (0 if disabled)
    uint256 poapDiscount;         // Discount amount/percentage
    DiscountType discountType;     // PERCENTAGE (0) or FIXED_AMOUNT (1)
}

enum DiscountType {
    PERCENTAGE,    // 0 - Discount as percentage (basis points)
    FIXED_AMOUNT   // 1 - Discount as fixed amount
}
```

### RedemptionStatus

Tracks physical item claim status.

```solidity
enum RedemptionStatus {
    NotRedeemed,        // 0 - User hasn't claimed yet
    PendingFulfillment, // 1 - User claimed, waiting for shipment
    Fulfilled           // 2 - Admin verified shipment complete
}
```

---

## State Variables

| Variable | Type | Description |
|----------|------|-------------|
| `designInfo` | `DesignInfo` | Complete Design metadata |
| `discountConfig` | `DiscountConfig` | Discount configuration |
| `treasury` | `address` | Treasury wallet for payments |
| `redemptions` | `mapping(uint256 => mapping(address => RedemptionStatus))` | Redemption status |

---

## User Functions

### mintDesign

Mint a Design NFT with selected size. **Works regardless of discount eligibility.**

```solidity
function mintDesign(string memory size, bool hasPoapDiscount) external nonReentrant
```

**Parameters:**
- `size` - Size selected by user (`"S"`, `"M"`, `"L"`, `"XL"`, `"NA"`)
- `hasPoapDiscount` - Flag if user has POAP (verified off-chain)

**Requirements:**
- Design must be `active`
- Supply available: `minted < totalSupply`
- Valid size selection
- User must have approved payment token

**Emits:** `DesignMinted(buyer, tokenId, size, price, hadDiscount)`

### mintDesignBatch

Batch mint multiple Design NFTs with selected sizes.

```solidity
function mintDesignBatch(string[] memory sizes, bool hasPoapDiscount) external nonReentrant
```

### requestPhysicalRedemption

Request redemption of physical item for owned NFT.

```solidity
function requestPhysicalRedemption(uint256 tokenId) external
```

**Requirements:**
- Caller must own the token
- Redemption status must be `NotRedeemed`

**Emits:** `PhysicalRedemptionRequested(owner, tokenId)`

---

## Admin Functions

### setDesignInfo

Set or update Design metadata.

```solidity
function setDesignInfo(DesignInfo memory info) external onlyRole(ADMIN_ROLE)
```

### setDesignDiscountConfig

Configure discount settings (optional).

```solidity
function setDesignDiscountConfig(DiscountConfig memory config) external onlyRole(ADMIN_ROLE)
```

### setDesignActive

Toggle Design sale status.

```solidity
function setDesignActive(bool active) external onlyRole(ADMIN_ROLE)
```

### setDesignPaymentToken

Update payment token for Design.

```solidity
function setDesignPaymentToken(address token) external onlyRole(ADMIN_ROLE)
```

### setDesignPrice

Update price per unit.

```solidity
function setDesignPrice(uint256 newPrice) external onlyRole(ADMIN_ROLE)
```

### setDesignTotalSupply

Update total supply (must be >= current minted).

```solidity
function setDesignTotalSupply(uint256 newSupply) external onlyRole(ADMIN_ROLE)
```

### markRedemptionFulfilled

Mark redemption as fulfilled after verifying shipment.

```solidity
function markRedemptionFulfilled(uint256 tokenId, address owner) external onlyRole(ADMIN_ROLE)
```

---

## View Functions

### getDesignInfo

Get complete Design information.

```solidity
function getDesignInfo() external view returns (DesignInfo memory)
```

### getDesignDiscountConfig

Get discount configuration.

```solidity
function getDesignDiscountConfig() external view returns (DiscountConfig memory)
```

### getDesignRemainingSupply

Get remaining supply available for minting.

```solidity
function getDesignRemainingSupply() external view returns (uint256)
```

### getDesignTokenSize

Get size trait for a specific token.

```solidity
function getDesignTokenSize(uint256 tokenId) external view returns (string memory)
```

### getDesignTokenTraits

Get all traits for a specific token.

```solidity
function getDesignTokenTraits(uint256 tokenId) external view returns (
    string memory size,
    string memory gender,
    string memory color,
    string memory style
)
```

### getDesignTokenRedemptionStatus

Get redemption status for a specific token and owner.

```solidity
function getDesignTokenRedemptionStatus(uint256 tokenId, address owner) external view returns (RedemptionStatus)
```

### getDesignPriceWithDiscounts

Calculate final price with discounts applied.

```solidity
function getDesignPriceWithDiscounts(address user, bool hasPoap) external view returns (uint256)
```

**Returns:** Final price after discounts (or full price if no discounts apply)

---

## Events

### User Events

| Event | Parameters | When Emitted |
|-------|------------|--------------|
| `DesignMinted` | `buyer`, `tokenId`, `size`, `price`, `hadDiscount` | Single mint via `mintDesign()` |
| `DesignMintedBatch` | `buyer`, `tokenIds[]`, `sizes[]`, `totalPrice` | Batch mint via `mintDesignBatch()` |
| `PhysicalRedemptionRequested` | `owner`, `tokenId` | User calls `requestPhysicalRedemption()` |

### Admin Events

| Event | Parameters | When Emitted |
|-------|------------|--------------|
| `DesignInfoUpdated` | `info` | `setDesignInfo()` |
| `DesignDiscountConfigUpdated` | `config` | `setDesignDiscountConfig()` |
| `DesignActiveStatusChanged` | `active` | `setDesignActive()` |
| `DesignPaymentTokenUpdated` | `newToken` | `setDesignPaymentToken()` |
| `DesignPriceUpdated` | `newPrice` | `setDesignPrice()` |
| `DesignTotalSupplyUpdated` | `newSupply` | `setDesignTotalSupply()` |
| `PhysicalRedemptionFulfilled` | `owner`, `tokenId`, `admin` | Admin calls `markRedemptionFulfilled()` |

---

## Error Messages

| Error | Cause | Solution |
|-------|-------|----------|
| `"Design not active"` | Trying to mint inactive Design | Admin must activate Design |
| `"Design sold out"` | No supply remaining | Wait for restock or new Design |
| `"Invalid size"` | Invalid size string | Use valid size: S, M, L, XL, or NA |
| `"not owner"` | Trying to redeem without owning NFT | User must own the token |
| `"already redeemed"` | Trying to redeem twice | NFT already redeemed |
| `"not pending"` | Admin trying to fulfill non-pending redemption | Status must be PendingFulfillment |

---

## Discount System

### Key Principle: Discounts Never Block Minting

**All discount fields are optional:**
- If not configured → minting works at full price
- If configured but user doesn't qualify → minting works at full price
- If configured and user qualifies → minting works at discounted price

### Smart Contract Discount

**On-chain verification:**
- Admin sets `smartContractAddress`
- Contract checks if user owns tokens from that contract OR user address has contract code
- If verified, discount is applied

### POAP Discount

**Off-chain verification:**
- Admin sets `poapEventId`
- Frontend calls POAP API: `GET https://api.poap.tech/actions/scan/{address}/{eventId}`
- If API returns POAP data, frontend passes `hasPoapDiscount = true`
- Contract applies discount if enabled and flag is true

### Discount Calculation

**Percentage Discount:**
- Uses 10000 basis points (10000 = 100%)
- Example: 1500 = 15% discount
- Formula: `finalPrice = basePrice * (10000 - discount) / 10000`

**Fixed Amount Discount:**
- Discount amount in payment token decimals
- Example: 10000000 = 10 USDC discount (6 decimals)
- Formula: `finalPrice = basePrice - discount`

---

# Part II: Frontend Integration

## Initial Setup

### 1. Install Dependencies

```bash
npm install wagmi viem @tanstack/react-query @tanstack/react-query-devtools
npm install @pinata/sdk zustand
```

### 2. Environment Configuration

Create `.env.local`:

```bash
# Design Contract Addresses (each Design is a separate contract)
VITE_DESIGN_1_ADDRESS_BASE=0x...
VITE_DESIGN_1_ADDRESS_ETHEREUM=0x...
VITE_DESIGN_1_ADDRESS_UNICHAIN=0x...

# Payment Token Addresses
VITE_USDC_ADDRESS_BASE=0x833589fCD6eDb6E08f4c7C32D4f71b54bdA02913
VITE_USDC_ADDRESS_ETHEREUM=0xA0b86991c6218b36c1d19D4a2e9Eb0cE3606eB48
VITE_USDC_ADDRESS_UNICHAIN=0x078D782b760474a361dDA0AF3839290b0EF57AD6

# IPFS/Pinata
VITE_PINATA_JWT=your_jwt_token
VITE_PINATA_GATEWAY=https://gateway.pinata.cloud/ipfs

# POAP API
VITE_POAP_API_KEY=your_poap_api_key
```

### 3. Get Contract ABI

```bash
npx hardhat run scripts/setup-frontend.ts
```

---

## Type Definitions

Create `src/types/swag1155.ts`:

```typescript
export type Size = 'S' | 'M' | 'L' | 'XL' | 'NA';

export interface DesignInfo {
  name: string;
  description: string;
  imageUrl: string;
  website: string;
  paymentToken: string;
  pricePerUnit: bigint;
  totalSupply: bigint;
  minted: bigint;
  active: boolean;
  gender: string;
  color: string;
  style: string;
}

export interface DiscountConfig {
  smartContractEnabled: boolean;
  smartContractAddress: string;
  smartContractDiscount: bigint;
  poapEnabled: boolean;
  poapEventId: bigint;
  poapDiscount: bigint;
  discountType: 0 | 1; // 0 = PERCENTAGE, 1 = FIXED_AMOUNT
}

export enum RedemptionStatus {
  NotRedeemed = 0,
  PendingFulfillment = 1,
  Fulfilled = 2,
}
```

---

## Hooks & Utilities

### Design Store Hook

Create `src/hooks/useDesignStore.ts`:

```typescript
import { useReadContract, useWriteContract, useAccount } from 'wagmi';
import Swag1155ABI from '../abis/Swag1155.json';
import ERC20ABI from '../abis/ERC20.json';
import { DesignInfo, DiscountConfig } from '../types/swag1155';

export function useDesignInfo(designAddress: string) {
  const { data, isLoading, error } = useReadContract({
    address: designAddress as `0x${string}`,
    abi: Swag1155ABI,
    functionName: 'getDesignInfo',
  });

  return {
    designInfo: data as DesignInfo | undefined,
    isLoading,
    error: error?.message || null,
  };
}

export function useDiscountConfig(designAddress: string) {
  const { data, isLoading, error } = useReadContract({
    address: designAddress as `0x${string}`,
    abi: Swag1155ABI,
    functionName: 'getDesignDiscountConfig',
  });

  return {
    discountConfig: data as DiscountConfig | undefined,
    isLoading,
    error: error?.message || null,
  };
}

export function useRemainingSupply(designAddress: string) {
  const { data, isLoading, error } = useReadContract({
    address: designAddress as `0x${string}`,
    abi: Swag1155ABI,
    functionName: 'getDesignRemainingSupply',
  });

  return {
    remaining: data ? Number(data) : 0,
    isLoading,
    error: error?.message || null,
  };
}

export function usePriceWithDiscounts(
  designAddress: string,
  userAddress?: string,
  hasPoap?: boolean
) {
  const { data, isLoading, error } = useReadContract({
    address: designAddress as `0x${string}`,
    abi: Swag1155ABI,
    functionName: 'getDesignPriceWithDiscounts',
    args: userAddress ? [userAddress as `0x${string}`, hasPoap || false] : undefined,
    query: { enabled: !!userAddress },
  });

  return {
    price: data || 0n,
    isLoading,
    error: error?.message || null,
  };
}

export function useMintDesign() {
  const { writeContractAsync: writeDesign } = useWriteContract();
  const { writeContractAsync: writePaymentToken } = useWriteContract();

  const mint = async (
    designAddress: string,
    paymentTokenAddress: string,
    size: string,
    hasPoapDiscount: boolean,
    price: bigint
  ) => {
    // Approve payment token
    await writePaymentToken({
      address: paymentTokenAddress as `0x${string}`,
      abi: ERC20ABI,
      functionName: 'approve',
      args: [designAddress as `0x${string}`, price],
    });

    // Mint
    return writeDesign({
      address: designAddress as `0x${string}`,
      abi: Swag1155ABI,
      functionName: 'mintDesign',
      args: [size, hasPoapDiscount],
    });
  };

  return { mint };
}
```

### POAP Verification Hook

Create `src/hooks/usePoapVerification.ts`:

```typescript
import { useState, useEffect } from 'react';
import { useAccount } from 'wagmi';
import { DiscountConfig } from '../types/swag1155';

export function usePoapVerification(
  designAddress: string,
  discountConfig?: DiscountConfig
) {
  const { address } = useAccount();
  const [hasPoap, setHasPoap] = useState(false);
  const [isChecking, setIsChecking] = useState(false);

  useEffect(() => {
    if (!address || !discountConfig?.poapEnabled || !discountConfig.poapEventId) {
      setHasPoap(false);
      return;
    }

    setIsChecking(true);
    fetch(
      `https://api.poap.tech/actions/scan/${address}/${discountConfig.poapEventId}`,
      {
        headers: {
          'x-api-key': import.meta.env.VITE_POAP_API_KEY || '',
        },
      }
    )
      .then((res) => res.json())
      .then((data) => {
        setHasPoap(data && data.length > 0);
      })
      .catch(() => setHasPoap(false))
      .finally(() => setIsChecking(false));
  }, [address, discountConfig?.poapEnabled, discountConfig?.poapEventId]);

  return { hasPoap, isChecking };
}
```

---

## User Components

### Design Card Component

Create `src/components/DesignCard.tsx`:

```typescript
import React, { useState } from 'react';
import { useAccount } from 'wagmi';
import {
  useDesignInfo,
  useRemainingSupply,
  usePriceWithDiscounts,
  useMintDesign,
} from '../hooks/useDesignStore';
import { useDiscountConfig } from '../hooks/useDesignStore';
import { usePoapVerification } from '../hooks/usePoapVerification';
import { getIPFSGatewayUrl } from '../services/pinata';
import { Size } from '../types/swag1155';

interface DesignCardProps {
  designAddress: string;
}

const AVAILABLE_SIZES: Size[] = ['S', 'M', 'L', 'XL', 'NA'];

export function DesignCard({ designAddress }: DesignCardProps) {
  const { address, isConnected } = useAccount();
  const { designInfo, isLoading: isDesignLoading } = useDesignInfo(designAddress);
  const { discountConfig } = useDiscountConfig(designAddress);
  const { remaining } = useRemainingSupply(designAddress);
  const { hasPoap } = usePoapVerification(designAddress, discountConfig);
  const { price } = usePriceWithDiscounts(designAddress, address, hasPoap);
  const { mint } = useMintDesign();

  const [selectedSize, setSelectedSize] = useState<Size>('M');
  const [isMinting, setIsMinting] = useState(false);

  if (isDesignLoading || !designInfo) {
    return <div className="design-card loading">Loading...</div>;
  }

  const imageUrl = getIPFSGatewayUrl(designInfo.imageUrl);
  const priceDisplay = Number(price) / 1e6;

  const handleMint = async () => {
    if (!isConnected) {
      alert('Connect wallet to mint');
      return;
    }

    if (!designInfo.active) {
      alert('Design not active');
      return;
    }

    if (remaining === 0) {
      alert('Sold out');
      return;
    }

    try {
      setIsMinting(true);
      await mint(
        designAddress,
        designInfo.paymentToken,
        selectedSize,
        hasPoap,
        price
      );
      alert('✅ Mint successful!');
    } catch (error) {
      console.error('Mint failed:', error);
      alert('Mint failed');
    } finally {
      setIsMinting(false);
    }
  };

  return (
    <div className="design-card">
      <div className="design-image">
        <img src={imageUrl} alt={designInfo.name} />
      </div>
      <div className="design-info">
        <h3>{designInfo.name}</h3>
        <p className="description">{designInfo.description}</p>
        <div className="traits">
          <span className="trait">Gender: {designInfo.gender}</span>
          <span className="trait">Color: {designInfo.color}</span>
          <span className="trait">Style: {designInfo.style}</span>
        </div>
        <p className="price">
          ${priceDisplay.toFixed(2)}
          {hasPoap && <span className="discount-badge">POAP Discount</span>}
        </p>
        <p className={`availability ${remaining > 0 ? 'in-stock' : 'sold-out'}`}>
          {remaining > 0 ? `${remaining} remaining` : 'Sold out'}
        </p>

        {remaining > 0 && designInfo.active && (
          <div className="mint-section">
            <div className="size-selector">
              {AVAILABLE_SIZES.map((size) => (
                <button
                  key={size}
                  className={`size-btn ${selectedSize === size ? 'active' : ''}`}
                  onClick={() => setSelectedSize(size)}
                  disabled={isMinting}
                >
                  {size}
                </button>
              ))}
            </div>
            <button
              onClick={handleMint}
              disabled={isMinting || !isConnected}
              className="btn btn-primary btn-block"
            >
              {isMinting ? 'Minting...' : `Mint ${selectedSize}`}
            </button>
          </div>
        )}
      </div>
    </div>
  );
}
```

---

## Admin Components

### Admin Design Management

See full implementation in the separate frontend guide for admin components, including:
- Design info updates
- Discount configuration
- Redemption fulfillment management

---

## Redemption Flow

### Redemption Hooks

```typescript
export function useRedemptionStatus(
  designAddress: string,
  tokenId: bigint,
  owner?: string
) {
  const { address } = useAccount();
  const ownerAddress = owner || address;

  const { data, isLoading, error, refetch } = useReadContract({
    address: designAddress as `0x${string}`,
    abi: Swag1155ABI,
    functionName: 'getDesignTokenRedemptionStatus',
    args: [tokenId, ownerAddress as `0x${string}`],
    query: { enabled: !!ownerAddress },
  });

  return {
    status: (data as number) ?? RedemptionStatus.NotRedeemed,
    isLoading,
    error: error?.message || null,
    refetch,
  };
}

export function useRequestRedemption() {
  const { writeContractAsync, isPending, error } = useWriteContract();

  const requestRedemption = async (designAddress: string, tokenId: bigint) => {
    return writeContractAsync({
      address: designAddress as `0x${string}`,
      abi: Swag1155ABI,
      functionName: 'requestPhysicalRedemption',
      args: [tokenId],
    });
  };

  return { requestRedemption, isPending, error: error?.message || null };
}
```

---

## Testing Checklist

### Design Management (Admin)
- [ ] Admin can update Design info
- [ ] Admin can configure discounts (POAP, smart contract)
- [ ] Admin can toggle Design active status
- [ ] Admin can update price and supply

### Store & Minting (User)
- [ ] User can view Design info
- [ ] User can see remaining supply
- [ ] User can see price with discounts applied
- [ ] User can verify POAP discount eligibility
- [ ] User can approve payment token
- [ ] User can mint single NFT with size selection
- [ ] User can mint batch with multiple sizes
- [ ] NFT appears in wallet after mint
- [ ] Sequential token IDs are correct (1, 2, 3...)
- [ ] Size trait is stored correctly

### Redemption Flow
- [ ] User can see "Redeem Physical Item" button on owned NFT
- [ ] User can call `requestPhysicalRedemption()` successfully
- [ ] Status changes to "Pending Fulfillment" after redemption
- [ ] Admin can mark redemption as fulfilled
- [ ] Status changes to "Fulfilled" after admin confirms

---

## Troubleshooting

### Minting Issues

| Issue | Solution |
|-------|----------|
| "Insufficient payment token" | User needs payment token on the network |
| "Approval failed" | User must first approve payment token |
| "Design not active" | Admin must activate Design |
| "Design sold out" | No supply remaining |
| "Invalid size" | Use valid size: S, M, L, XL, or NA |

### Redemption Issues

| Issue | Solution |
|-------|----------|
| "not owner" | User must own the NFT to redeem |
| "already redeemed" | NFT already redeemed |
| "not pending" | Status must be PendingFulfillment |

---

## Support & Questions

- **Contract Source**: `contracts/Swag1155.sol`
- **Tests**: `test/Swag1155.test.ts`
- **Deployment**: `scripts/deploy-design.ts`